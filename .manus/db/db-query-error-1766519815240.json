{
  "query": "-- ============================================================================\n-- Migration 027: Fix VSL Conversion Rate and Add Drop-off Metrics\n-- \n-- Changes:\n-- 1. Change conversion baseline from 95% to 50% (more meaningful engagement)\n-- 2. Count only purchases from VSL viewers (not all purchases)\n-- 3. Add drop-off percentages between milestones\n-- 4. Add purchases_from_vsl_viewers metric\n-- ============================================================================\n\nDROP FUNCTION IF EXISTS get_dashboard_metrics(date, date);\n\nCREATE OR REPLACE FUNCTION get_dashboard_metrics(\n    p_start_date date DEFAULT (CURRENT_DATE - '30 days'::interval),\n    p_end_date date DEFAULT CURRENT_DATE\n)\nRETURNS jsonb\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET statement_timeout = '120s'\nAS $function$\nDECLARE\n    v_result JSONB;\n    v_next_day_str TEXT;\nBEGIN\n    -- Calculate next day for inclusive end date filtering\n    v_next_day_str := (p_end_date + interval '1 day')::date::text;\n    \n    -- Build result using CTEs with materialized views\n    WITH \n    -- CTE 1: Filter leads by date range using materialized view\n    wisdom_leads AS (\n        SELECT \n            wlc.contact_id,\n            wlc.created_at,\n            wlc.is_paid,\n            wlc.is_organic,\n            wlc.has_manychat\n        FROM wisdom_lead_classification wlc\n        WHERE wlc.created_at >= p_start_date::timestamp\n          AND wlc.created_at < v_next_day_str::timestamp\n    ),\n    -- CTE 2: Lead counts\n    lead_metrics AS (\n        SELECT\n            COUNT(*) as total_leads,\n            COUNT(*) FILTER (WHERE is_paid) as paid_leads,\n            COUNT(*) FILTER (WHERE is_organic AND NOT is_paid) as organic_leads,\n            COUNT(*) FILTER (WHERE has_manychat) as total_manychat,\n            COUNT(*) FILTER (WHERE has_manychat AND is_paid) as paid_manychat,\n            COUNT(*) FILTER (WHERE has_manychat AND is_organic AND NOT is_paid) as organic_manychat\n        FROM wisdom_leads\n    ),\n    -- CTE 3: Orders in date range for wisdom funnel\n    wisdom_orders AS (\n        SELECT \n            o.id,\n            o.contact_id,\n            o.order_total,\n            o.funnel_name,\n            o.billing_status,\n            o.created_at\n        FROM orders o\n        WHERE o.created_at >= p_start_date::timestamp\n          AND o.created_at < v_next_day_str::timestamp\n          AND o.funnel_name LIKE '%wisdom%'\n          AND o.billing_status IN ('paid', 'partially-refunded')\n    ),\n    -- CTE 4: Product sales breakdown\n    product_sales AS (\n        SELECT\n            -- Wisdom+ Sales (all wisdom orders)\n            COUNT(DISTINCT wo.id) as wisdom_sales,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_wisdom_sales,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_wisdom_sales,\n            \n            -- Kingdom Seekers (by product_id in order_items)\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as kingdom_seekers,\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%'\n                AND EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as paid_kingdom_seekers,\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%'\n                AND EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as organic_kingdom_seekers,\n            \n            -- Extra Journals (by funnel_name)\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%') as extra_journals,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%' AND wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_extra_journals,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%' AND wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_extra_journals,\n            \n            -- Extra Shipping (by funnel_name)\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%') as extra_shipping,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%' AND wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_extra_shipping,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%' AND wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_extra_shipping,\n            \n            -- Revenue\n            SUM(wo.order_total) as total_revenue,\n            SUM(wo.order_total) FILTER (WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_revenue,\n            SUM(wo.order_total) FILTER (WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_revenue\n        FROM wisdom_orders wo\n    ),\n    -- CTE 5: Engagement metrics (bot alerts, welcome email clicks)\n    engagement_metrics AS (\n        SELECT\n            COUNT(DISTINCT ae.contact_id) FILTER (WHERE ae.name = 'manychat.add_tag' AND ae.value = 'gold.ntn.request_accepted' AND wl.is_paid) as paid_bot_alerts,\n            COUNT(DISTINCT ae.contact_id) FILTER (WHERE ae.name = 'manychat.add_tag' AND ae.value = 'gold.ntn.request_accepted' AND wl.is_organic AND NOT wl.is_paid) as organic_bot_alerts,\n            -- Email clicks: currently no keap.email.clicked events in analytics_events\n            0 as paid_welcome_clicks,\n            0 as organic_welcome_clicks\n        FROM analytics_events ae\n        JOIN wisdom_leads wl ON ae.contact_id = wl.contact_id\n        WHERE ae.timestamp >= p_start_date::timestamp\n          AND ae.timestamp < v_next_day_str::timestamp\n    ),\n    -- CTE 6: Ad performance metrics\n    ad_metrics AS (\n        SELECT\n            -- Meta totals\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta') as meta_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta') as meta_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta') as meta_impressions,\n            SUM(landing_page_views) FILTER (WHERE platform ILIKE 'meta') as meta_landing_page_views,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta') as meta_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta') as meta_purchases,\n            \n            -- Meta Sales campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_purchases,\n            \n            -- Meta Leads campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_purchases,\n            \n            -- Meta Retargeting campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_purchases,\n            \n            -- Meta Content campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_purchases,\n            \n            -- Meta Other campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_purchases,\n            \n            -- Google totals\n            SUM(spend) FILTER (WHERE platform ILIKE 'google') as google_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'google') as google_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'google') as google_impressions,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'google') as google_conversions,\n            \n            -- Total spend\n            SUM(spend) as total_spend,\n            \n            -- Link clicks and landing page views\n            SUM(link_clicks) as link_clicks,\n            SUM(landing_page_views) FILTER (WHERE platform ILIKE 'meta') as landing_page_views\n        FROM ad_performance\n        WHERE date >= p_start_date\n          AND date <= p_end_date\n    ),\n    -- CTE 7: VSL metrics (using materialized view) with drop-off percentages\n    vsl_metrics AS (\n        SELECT\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_5_percent = 1) as vsl_5_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_25_percent = 1) as vsl_25_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_50_percent = 1) as vsl_50_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_95_percent = 1) as vsl_95_percent,\n            -- Count purchases from VSL viewers (using 50% baseline)\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE EXISTS (\n                    SELECT 1 FROM vsl_analytics va\n                    WHERE va.contact_id = wo.contact_id\n                    AND va.watched_50_percent = 1\n                    AND va.watch_date >= p_start_date\n                    AND va.watch_date <= p_end_date\n                )\n            ) as purchases_from_vsl_viewers\n        FROM vsl_analytics\n        CROSS JOIN wisdom_orders wo\n        WHERE watch_date >= p_start_date\n          AND watch_date <= p_end_date\n    )\n    \n    -- Final SELECT: Build JSON response with ALL fields\n    SELECT jsonb_build_object(\n        'kpis', jsonb_build_object(\n            'totalLeads', lm.total_leads,\n            'totalWisdomSales', ps.wisdom_sales,\n            'totalKingdomSeekers', ps.kingdom_seekers,\n            'totalRevenue', COALESCE(ps.total_revenue, 0),\n            'totalSpend', COALESCE(am.total_spend, 0),\n            'cpl', CASE WHEN lm.total_leads > 0 THEN COALESCE(am.total_spend, 0) / lm.total_leads ELSE 0 END,\n            'cpp', CASE WHEN ps.wisdom_sales > 0 THEN COALESCE(am.total_spend, 0) / ps.wisdom_sales ELSE 0 END,\n            'aov', CASE WHEN ps.wisdom_sales > 0 THEN ROUND((ps.total_revenue / ps.wisdom_sales)::numeric, 2) ELSE 0 END,\n            'roas', CASE WHEN am.total_spend > 0 THEN COALESCE(ps.total_revenue, 0) / am.total_spend ELSE 0 END,\n            'conversionRate', CASE WHEN lm.total_leads > 0 THEN (ps.wisdom_sales::float / lm.total_leads * 100) ELSE 0 END\n        ),\n        'paidAdsFunnel', jsonb_build_object(\n            'leads', lm.paid_leads,\n            'wisdomSales', ps.paid_wisdom_sales,\n            'kingdomSeekers', ps.paid_kingdom_seekers,\n            'extraJournals', ps.paid_extra_journals,\n            'extraShipping', ps.paid_extra_shipping,\n            'manychatConnected', lm.paid_manychat,\n            'botAlertsSubscribed', em.paid_bot_alerts,\n            'welcomeEmailClicks', em.paid_welcome_clicks\n        ),\n        'organicFunnel', jsonb_build_object(\n            'leads', lm.organic_leads,\n            'wisdomSales', ps.organic_wisdom_sales,\n            'kingdomSeekers', ps.organic_kingdom_seekers,\n            'extraJournals', ps.organic_extra_journals,\n            'extraShipping', ps.organic_extra_shipping,\n            'manychatConnected', lm.organic_manychat,\n            'botAlertsSubscribed', em.organic_bot_alerts,\n            'welcomeEmailClicks', em.organic_welcome_clicks\n        ),\n        'metaPerformance', jsonb_build_object(\n            'spend', COALESCE(am.meta_spend, 0),\n            'clicks', COALESCE(am.meta_clicks, 0),\n            'impressions', COALESCE(am.meta_impressions, 0),\n            'landingPageViews', COALESCE(am.meta_landing_page_views, 0),\n            'leads', COALESCE(am.meta_leads, 0),\n            'purchases', COALESCE(am.meta_purchases, 0),\n            'cpc', CASE WHEN am.meta_clicks > 0 THEN am.meta_spend / am.meta_clicks ELSE 0 END,\n            'cpm', CASE WHEN am.meta_impressions > 0 THEN (am.meta_spend / am.meta_impressions) * 1000 ELSE 0 END,\n            'ctr', CASE WHEN am.meta_impressions > 0 THEN (am.meta_clicks::numeric / am.meta_impressions) * 100 ELSE 0 END,\n            'cpp', CASE WHEN am.meta_purchases > 0 THEN am.meta_spend / am.meta_purchases ELSE 0 END,\n            'cpl', CASE WHEN am.meta_leads > 0 THEN am.meta_spend / am.meta_leads ELSE 0 END,\n            'salesRate', CASE WHEN am.meta_leads > 0 THEN (am.meta_purchases::numeric / am.meta_leads) * 100 ELSE 0 END,\n            'leadRate', CASE WHEN am.meta_clicks > 0 THEN (am.meta_leads::numeric / am.meta_clicks) * 100 ELSE 0 END\n        ),\n        'metaCampaignBreakdown', jsonb_build_object(\n            'sales', jsonb_build_object(\n                'spend', COALESCE(am.meta_sales_spend, 0),\n                'clicks', COALESCE(am.meta_sales_clicks, 0),\n                'impressions', COALESCE(am.meta_sales_impressions, 0),\n                'leads', COALESCE(am.meta_sales_leads, 0),\n                'purchases', COALESCE(am.meta_sales_purchases, 0),\n                'cpc', CASE WHEN am.meta_sales_clicks > 0 THEN am.meta_sales_spend / am.meta_sales_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_sales_impressions > 0 THEN (am.meta_sales_spend / am.meta_sales_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_sales_impressions > 0 THEN (am.meta_sales_clicks::numeric / am.meta_sales_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_sales_purchases > 0 THEN am.meta_sales_spend / am.meta_sales_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_sales_leads > 0 THEN am.meta_sales_spend / am.meta_sales_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_sales_leads > 0 THEN (am.meta_sales_purchases::numeric / am.meta_sales_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_sales_clicks > 0 THEN (am.meta_sales_leads::numeric / am.meta_sales_clicks) * 100 ELSE 0 END\n            ),\n            'leads', jsonb_build_object(\n                'spend', COALESCE(am.meta_leads_spend, 0),\n                'clicks', COALESCE(am.meta_leads_clicks, 0),\n                'impressions', COALESCE(am.meta_leads_impressions, 0),\n                'leads', COALESCE(am.meta_leads_leads, 0),\n                'purchases', COALESCE(am.meta_leads_purchases, 0),\n                'cpc', CASE WHEN am.meta_leads_clicks > 0 THEN am.meta_leads_spend / am.meta_leads_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_leads_impressions > 0 THEN (am.meta_leads_spend / am.meta_leads_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_leads_impressions > 0 THEN (am.meta_leads_clicks::numeric / am.meta_leads_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_leads_purchases > 0 THEN am.meta_leads_spend / am.meta_leads_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_leads_leads > 0 THEN am.meta_leads_spend / am.meta_leads_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_leads_leads > 0 THEN (am.meta_leads_purchases::numeric / am.meta_leads_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_leads_clicks > 0 THEN (am.meta_leads_leads::numeric / am.meta_leads_clicks) * 100 ELSE 0 END\n            ),\n            'retargeting', jsonb_build_object(\n                'spend', COALESCE(am.meta_retargeting_spend, 0),\n                'clicks', COALESCE(am.meta_retargeting_clicks, 0),\n                'impressions', COALESCE(am.meta_retargeting_impressions, 0),\n                'leads', COALESCE(am.meta_retargeting_leads, 0),\n                'purchases', COALESCE(am.meta_retargeting_purchases, 0),\n                'cpc', CASE WHEN am.meta_retargeting_clicks > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_retargeting_impressions > 0 THEN (am.meta_retargeting_spend / am.meta_retargeting_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_retargeting_impressions > 0 THEN (am.meta_retargeting_clicks::numeric / am.meta_retargeting_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_retargeting_purchases > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_retargeting_leads > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_retargeting_leads > 0 THEN (am.meta_retargeting_purchases::numeric / am.meta_retargeting_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_retargeting_clicks > 0 THEN (am.meta_retargeting_leads::numeric / am.meta_retargeting_clicks) * 100 ELSE 0 END\n            ),\n            'content', jsonb_build_object(\n                'spend', COALESCE(am.meta_content_spend, 0),\n                'clicks', COALESCE(am.meta_content_clicks, 0),\n                'impressions', COALESCE(am.meta_content_impressions, 0),\n                'leads', COALESCE(am.meta_content_leads, 0),\n                'purchases', COALESCE(am.meta_content_purchases, 0),\n                'cpc', CASE WHEN am.meta_content_clicks > 0 THEN am.meta_content_spend / am.meta_content_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_content_impressions > 0 THEN (am.meta_content_spend / am.meta_content_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_content_impressions > 0 THEN (am.meta_content_clicks::numeric / am.meta_content_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_content_purchases > 0 THEN am.meta_content_spend / am.meta_content_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_content_leads > 0 THEN am.meta_content_spend / am.meta_content_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_content_leads > 0 THEN (am.meta_content_purchases::numeric / am.meta_content_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_content_clicks > 0 THEN (am.meta_content_leads::numeric / am.meta_content_clicks) * 100 ELSE 0 END\n            ),\n            'other', jsonb_build_object(\n                'spend', COALESCE(am.meta_other_spend, 0),\n                'clicks', COALESCE(am.meta_other_clicks, 0),\n                'impressions', COALESCE(am.meta_other_impressions, 0),\n                'leads', COALESCE(am.meta_other_leads, 0),\n                'purchases', COALESCE(am.meta_other_purchases, 0),\n                'cpc', CASE WHEN am.meta_other_clicks > 0 THEN am.meta_other_spend / am.meta_other_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_other_impressions > 0 THEN (am.meta_other_spend / am.meta_other_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_other_impressions > 0 THEN (am.meta_other_clicks::numeric / am.meta_other_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_other_purchases > 0 THEN am.meta_other_spend / am.meta_other_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_other_leads > 0 THEN am.meta_other_spend / am.meta_other_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_other_leads > 0 THEN (am.meta_other_purchases::numeric / am.meta_other_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_other_clicks > 0 THEN (am.meta_other_leads::numeric / am.meta_other_clicks) * 100 ELSE 0 END\n            )\n        ),\n        'googlePerformance', jsonb_build_object(\n            'spend', COALESCE(am.google_spend, 0),\n            'clicks', COALESCE(am.google_clicks, 0),\n            'impressions', COALESCE(am.google_impressions, 0),\n            'conversions', COALESCE(am.google_conversions, 0),\n            'cpc', CASE WHEN am.google_clicks > 0 THEN am.google_spend / am.google_clicks ELSE 0 END,\n            'cpm', CASE WHEN am.google_impressions > 0 THEN (am.google_spend / am.google_impressions) * 1000 ELSE 0 END,\n            'ctr', CASE WHEN am.google_impressions > 0 THEN (am.google_clicks::numeric / am.google_impressions) * 100 ELSE 0 END\n        ),\n        'vslPerformance', jsonb_build_object(\n            'watched5Percent', COALESCE(vm.vsl_5_percent, 0),\n            'watched25Percent', COALESCE(vm.vsl_25_percent, 0),\n            'watched50Percent', COALESCE(vm.vsl_50_percent, 0),\n            'watched95Percent', COALESCE(vm.vsl_95_percent, 0),\n            -- Drop-off percentages\n            'dropoff5to25', CASE WHEN vm.vsl_5_percent > 0 THEN ((1 - vm.vsl_25_percent::numeric / vm.vsl_5_percent) * 100) ELSE 0 END,\n            'dropoff25to50', CASE WHEN vm.vsl_25_percent > 0 THEN ((1 - vm.vsl_50_percent::numeric / vm.vsl_25_percent) * 100) ELSE 0 END,\n            'dropoff50to95', CASE WHEN vm.vsl_50_percent > 0 THEN ((1 - vm.vsl_95_percent::numeric / vm.vsl_50_percent) * 100) ELSE 0 END,\n            -- Purchases from VSL viewers\n            'purchasesFromVslViewers', COALESCE(vm.purchases_from_vsl_viewers, 0),\n            -- Conversion rate: purchases from VSL viewers / VSL 50% viewers\n            'conversionRate', CASE WHEN vm.vsl_50_percent > 0 THEN (vm.purchases_from_vsl_viewers::numeric / vm.vsl_50_percent) * 100 ELSE 0 END\n        )\n    ) INTO v_result\n    FROM lead_metrics lm\n    CROSS JOIN product_sales ps\n    CROSS JOIN engagement_metrics em\n    CROSS JOIN ad_metrics am\n    CROSS JOIN vsl_metrics vm;\n    \n    RETURN v_result;\nEND;\n$function$;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 2j9rVuZuRurkhgi.64ac36f98b86 --database DEFt9ARHDVCZprKAKnwLBw --execute -- ============================================================================\n-- Migration 027: Fix VSL Conversion Rate and Add Drop-off Metrics\n-- \n-- Changes:\n-- 1. Change conversion baseline from 95% to 50% (more meaningful engagement)\n-- 2. Count only purchases from VSL viewers (not all purchases)\n-- 3. Add drop-off percentages between milestones\n-- 4. Add purchases_from_vsl_viewers metric\n-- ============================================================================\n\nDROP FUNCTION IF EXISTS get_dashboard_metrics(date, date);\n\nCREATE OR REPLACE FUNCTION get_dashboard_metrics(\n    p_start_date date DEFAULT (CURRENT_DATE - '30 days'::interval),\n    p_end_date date DEFAULT CURRENT_DATE\n)\nRETURNS jsonb\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET statement_timeout = '120s'\nAS $function$\nDECLARE\n    v_result JSONB;\n    v_next_day_str TEXT;\nBEGIN\n    -- Calculate next day for inclusive end date filtering\n    v_next_day_str := (p_end_date + interval '1 day')::date::text;\n    \n    -- Build result using CTEs with materialized views\n    WITH \n    -- CTE 1: Filter leads by date range using materialized view\n    wisdom_leads AS (\n        SELECT \n            wlc.contact_id,\n            wlc.created_at,\n            wlc.is_paid,\n            wlc.is_organic,\n            wlc.has_manychat\n        FROM wisdom_lead_classification wlc\n        WHERE wlc.created_at >= p_start_date::timestamp\n          AND wlc.created_at < v_next_day_str::timestamp\n    ),\n    -- CTE 2: Lead counts\n    lead_metrics AS (\n        SELECT\n            COUNT(*) as total_leads,\n            COUNT(*) FILTER (WHERE is_paid) as paid_leads,\n            COUNT(*) FILTER (WHERE is_organic AND NOT is_paid) as organic_leads,\n            COUNT(*) FILTER (WHERE has_manychat) as total_manychat,\n            COUNT(*) FILTER (WHERE has_manychat AND is_paid) as paid_manychat,\n            COUNT(*) FILTER (WHERE has_manychat AND is_organic AND NOT is_paid) as organic_manychat\n        FROM wisdom_leads\n    ),\n    -- CTE 3: Orders in date range for wisdom funnel\n    wisdom_orders AS (\n        SELECT \n            o.id,\n            o.contact_id,\n            o.order_total,\n            o.funnel_name,\n            o.billing_status,\n            o.created_at\n        FROM orders o\n        WHERE o.created_at >= p_start_date::timestamp\n          AND o.created_at < v_next_day_str::timestamp\n          AND o.funnel_name LIKE '%wisdom%'\n          AND o.billing_status IN ('paid', 'partially-refunded')\n    ),\n    -- CTE 4: Product sales breakdown\n    product_sales AS (\n        SELECT\n            -- Wisdom+ Sales (all wisdom orders)\n            COUNT(DISTINCT wo.id) as wisdom_sales,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_wisdom_sales,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_wisdom_sales,\n            \n            -- Kingdom Seekers (by product_id in order_items)\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as kingdom_seekers,\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%'\n                AND EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as paid_kingdom_seekers,\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%'\n                AND EXISTS (\n                    SELECT 1 FROM order_items oi \n                    WHERE oi.order_id = wo.id \n                    AND oi.product_id = 8\n                )\n            ) as organic_kingdom_seekers,\n            \n            -- Extra Journals (by funnel_name)\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%') as extra_journals,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%' AND wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_extra_journals,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%extra%journal%' AND wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_extra_journals,\n            \n            -- Extra Shipping (by funnel_name)\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%') as extra_shipping,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%' AND wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_extra_shipping,\n            COUNT(DISTINCT wo.id) FILTER (WHERE wo.funnel_name ILIKE '%shipping%' AND wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_extra_shipping,\n            \n            -- Revenue\n            SUM(wo.order_total) as total_revenue,\n            SUM(wo.order_total) FILTER (WHERE wo.funnel_name LIKE '%31daywisdom.com%' AND wo.funnel_name NOT LIKE '%challenge%') as paid_revenue,\n            SUM(wo.order_total) FILTER (WHERE wo.funnel_name LIKE '%31daywisdomchallenge.com%') as organic_revenue\n        FROM wisdom_orders wo\n    ),\n    -- CTE 5: Engagement metrics (bot alerts, welcome email clicks)\n    engagement_metrics AS (\n        SELECT\n            COUNT(DISTINCT ae.contact_id) FILTER (WHERE ae.name = 'manychat.add_tag' AND ae.value = 'gold.ntn.request_accepted' AND wl.is_paid) as paid_bot_alerts,\n            COUNT(DISTINCT ae.contact_id) FILTER (WHERE ae.name = 'manychat.add_tag' AND ae.value = 'gold.ntn.request_accepted' AND wl.is_organic AND NOT wl.is_paid) as organic_bot_alerts,\n            -- Email clicks: currently no keap.email.clicked events in analytics_events\n            0 as paid_welcome_clicks,\n            0 as organic_welcome_clicks\n        FROM analytics_events ae\n        JOIN wisdom_leads wl ON ae.contact_id = wl.contact_id\n        WHERE ae.timestamp >= p_start_date::timestamp\n          AND ae.timestamp < v_next_day_str::timestamp\n    ),\n    -- CTE 6: Ad performance metrics\n    ad_metrics AS (\n        SELECT\n            -- Meta totals\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta') as meta_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta') as meta_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta') as meta_impressions,\n            SUM(landing_page_views) FILTER (WHERE platform ILIKE 'meta') as meta_landing_page_views,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta') as meta_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta') as meta_purchases,\n            \n            -- Meta Sales campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%sales%') as meta_sales_purchases,\n            \n            -- Meta Leads campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%lead%' AND campaign_name NOT ILIKE '%sales%') as meta_leads_purchases,\n            \n            -- Meta Retargeting campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%retarget%') as meta_retargeting_purchases,\n            \n            -- Meta Content campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name ILIKE '%content%') as meta_content_purchases,\n            \n            -- Meta Other campaigns\n            SUM(spend) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_impressions,\n            SUM(reported_leads) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_leads,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'meta' AND campaign_name NOT ILIKE '%sales%' AND campaign_name NOT ILIKE '%lead%' AND campaign_name NOT ILIKE '%retarget%' AND campaign_name NOT ILIKE '%content%') as meta_other_purchases,\n            \n            -- Google totals\n            SUM(spend) FILTER (WHERE platform ILIKE 'google') as google_spend,\n            SUM(link_clicks) FILTER (WHERE platform ILIKE 'google') as google_clicks,\n            SUM(impressions) FILTER (WHERE platform ILIKE 'google') as google_impressions,\n            SUM(reported_purchases) FILTER (WHERE platform ILIKE 'google') as google_conversions,\n            \n            -- Total spend\n            SUM(spend) as total_spend,\n            \n            -- Link clicks and landing page views\n            SUM(link_clicks) as link_clicks,\n            SUM(landing_page_views) FILTER (WHERE platform ILIKE 'meta') as landing_page_views\n        FROM ad_performance\n        WHERE date >= p_start_date\n          AND date <= p_end_date\n    ),\n    -- CTE 7: VSL metrics (using materialized view) with drop-off percentages\n    vsl_metrics AS (\n        SELECT\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_5_percent = 1) as vsl_5_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_25_percent = 1) as vsl_25_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_50_percent = 1) as vsl_50_percent,\n            COUNT(DISTINCT contact_id) FILTER (WHERE watched_95_percent = 1) as vsl_95_percent,\n            -- Count purchases from VSL viewers (using 50% baseline)\n            COUNT(DISTINCT wo.id) FILTER (\n                WHERE EXISTS (\n                    SELECT 1 FROM vsl_analytics va\n                    WHERE va.contact_id = wo.contact_id\n                    AND va.watched_50_percent = 1\n                    AND va.watch_date >= p_start_date\n                    AND va.watch_date <= p_end_date\n                )\n            ) as purchases_from_vsl_viewers\n        FROM vsl_analytics\n        CROSS JOIN wisdom_orders wo\n        WHERE watch_date >= p_start_date\n          AND watch_date <= p_end_date\n    )\n    \n    -- Final SELECT: Build JSON response with ALL fields\n    SELECT jsonb_build_object(\n        'kpis', jsonb_build_object(\n            'totalLeads', lm.total_leads,\n            'totalWisdomSales', ps.wisdom_sales,\n            'totalKingdomSeekers', ps.kingdom_seekers,\n            'totalRevenue', COALESCE(ps.total_revenue, 0),\n            'totalSpend', COALESCE(am.total_spend, 0),\n            'cpl', CASE WHEN lm.total_leads > 0 THEN COALESCE(am.total_spend, 0) / lm.total_leads ELSE 0 END,\n            'cpp', CASE WHEN ps.wisdom_sales > 0 THEN COALESCE(am.total_spend, 0) / ps.wisdom_sales ELSE 0 END,\n            'aov', CASE WHEN ps.wisdom_sales > 0 THEN ROUND((ps.total_revenue / ps.wisdom_sales)::numeric, 2) ELSE 0 END,\n            'roas', CASE WHEN am.total_spend > 0 THEN COALESCE(ps.total_revenue, 0) / am.total_spend ELSE 0 END,\n            'conversionRate', CASE WHEN lm.total_leads > 0 THEN (ps.wisdom_sales::float / lm.total_leads * 100) ELSE 0 END\n        ),\n        'paidAdsFunnel', jsonb_build_object(\n            'leads', lm.paid_leads,\n            'wisdomSales', ps.paid_wisdom_sales,\n            'kingdomSeekers', ps.paid_kingdom_seekers,\n            'extraJournals', ps.paid_extra_journals,\n            'extraShipping', ps.paid_extra_shipping,\n            'manychatConnected', lm.paid_manychat,\n            'botAlertsSubscribed', em.paid_bot_alerts,\n            'welcomeEmailClicks', em.paid_welcome_clicks\n        ),\n        'organicFunnel', jsonb_build_object(\n            'leads', lm.organic_leads,\n            'wisdomSales', ps.organic_wisdom_sales,\n            'kingdomSeekers', ps.organic_kingdom_seekers,\n            'extraJournals', ps.organic_extra_journals,\n            'extraShipping', ps.organic_extra_shipping,\n            'manychatConnected', lm.organic_manychat,\n            'botAlertsSubscribed', em.organic_bot_alerts,\n            'welcomeEmailClicks', em.organic_welcome_clicks\n        ),\n        'metaPerformance', jsonb_build_object(\n            'spend', COALESCE(am.meta_spend, 0),\n            'clicks', COALESCE(am.meta_clicks, 0),\n            'impressions', COALESCE(am.meta_impressions, 0),\n            'landingPageViews', COALESCE(am.meta_landing_page_views, 0),\n            'leads', COALESCE(am.meta_leads, 0),\n            'purchases', COALESCE(am.meta_purchases, 0),\n            'cpc', CASE WHEN am.meta_clicks > 0 THEN am.meta_spend / am.meta_clicks ELSE 0 END,\n            'cpm', CASE WHEN am.meta_impressions > 0 THEN (am.meta_spend / am.meta_impressions) * 1000 ELSE 0 END,\n            'ctr', CASE WHEN am.meta_impressions > 0 THEN (am.meta_clicks::numeric / am.meta_impressions) * 100 ELSE 0 END,\n            'cpp', CASE WHEN am.meta_purchases > 0 THEN am.meta_spend / am.meta_purchases ELSE 0 END,\n            'cpl', CASE WHEN am.meta_leads > 0 THEN am.meta_spend / am.meta_leads ELSE 0 END,\n            'salesRate', CASE WHEN am.meta_leads > 0 THEN (am.meta_purchases::numeric / am.meta_leads) * 100 ELSE 0 END,\n            'leadRate', CASE WHEN am.meta_clicks > 0 THEN (am.meta_leads::numeric / am.meta_clicks) * 100 ELSE 0 END\n        ),\n        'metaCampaignBreakdown', jsonb_build_object(\n            'sales', jsonb_build_object(\n                'spend', COALESCE(am.meta_sales_spend, 0),\n                'clicks', COALESCE(am.meta_sales_clicks, 0),\n                'impressions', COALESCE(am.meta_sales_impressions, 0),\n                'leads', COALESCE(am.meta_sales_leads, 0),\n                'purchases', COALESCE(am.meta_sales_purchases, 0),\n                'cpc', CASE WHEN am.meta_sales_clicks > 0 THEN am.meta_sales_spend / am.meta_sales_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_sales_impressions > 0 THEN (am.meta_sales_spend / am.meta_sales_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_sales_impressions > 0 THEN (am.meta_sales_clicks::numeric / am.meta_sales_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_sales_purchases > 0 THEN am.meta_sales_spend / am.meta_sales_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_sales_leads > 0 THEN am.meta_sales_spend / am.meta_sales_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_sales_leads > 0 THEN (am.meta_sales_purchases::numeric / am.meta_sales_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_sales_clicks > 0 THEN (am.meta_sales_leads::numeric / am.meta_sales_clicks) * 100 ELSE 0 END\n            ),\n            'leads', jsonb_build_object(\n                'spend', COALESCE(am.meta_leads_spend, 0),\n                'clicks', COALESCE(am.meta_leads_clicks, 0),\n                'impressions', COALESCE(am.meta_leads_impressions, 0),\n                'leads', COALESCE(am.meta_leads_leads, 0),\n                'purchases', COALESCE(am.meta_leads_purchases, 0),\n                'cpc', CASE WHEN am.meta_leads_clicks > 0 THEN am.meta_leads_spend / am.meta_leads_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_leads_impressions > 0 THEN (am.meta_leads_spend / am.meta_leads_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_leads_impressions > 0 THEN (am.meta_leads_clicks::numeric / am.meta_leads_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_leads_purchases > 0 THEN am.meta_leads_spend / am.meta_leads_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_leads_leads > 0 THEN am.meta_leads_spend / am.meta_leads_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_leads_leads > 0 THEN (am.meta_leads_purchases::numeric / am.meta_leads_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_leads_clicks > 0 THEN (am.meta_leads_leads::numeric / am.meta_leads_clicks) * 100 ELSE 0 END\n            ),\n            'retargeting', jsonb_build_object(\n                'spend', COALESCE(am.meta_retargeting_spend, 0),\n                'clicks', COALESCE(am.meta_retargeting_clicks, 0),\n                'impressions', COALESCE(am.meta_retargeting_impressions, 0),\n                'leads', COALESCE(am.meta_retargeting_leads, 0),\n                'purchases', COALESCE(am.meta_retargeting_purchases, 0),\n                'cpc', CASE WHEN am.meta_retargeting_clicks > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_retargeting_impressions > 0 THEN (am.meta_retargeting_spend / am.meta_retargeting_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_retargeting_impressions > 0 THEN (am.meta_retargeting_clicks::numeric / am.meta_retargeting_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_retargeting_purchases > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_retargeting_leads > 0 THEN am.meta_retargeting_spend / am.meta_retargeting_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_retargeting_leads > 0 THEN (am.meta_retargeting_purchases::numeric / am.meta_retargeting_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_retargeting_clicks > 0 THEN (am.meta_retargeting_leads::numeric / am.meta_retargeting_clicks) * 100 ELSE 0 END\n            ),\n            'content', jsonb_build_object(\n                'spend', COALESCE(am.meta_content_spend, 0),\n                'clicks', COALESCE(am.meta_content_clicks, 0),\n                'impressions', COALESCE(am.meta_content_impressions, 0),\n                'leads', COALESCE(am.meta_content_leads, 0),\n                'purchases', COALESCE(am.meta_content_purchases, 0),\n                'cpc', CASE WHEN am.meta_content_clicks > 0 THEN am.meta_content_spend / am.meta_content_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_content_impressions > 0 THEN (am.meta_content_spend / am.meta_content_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_content_impressions > 0 THEN (am.meta_content_clicks::numeric / am.meta_content_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_content_purchases > 0 THEN am.meta_content_spend / am.meta_content_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_content_leads > 0 THEN am.meta_content_spend / am.meta_content_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_content_leads > 0 THEN (am.meta_content_purchases::numeric / am.meta_content_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_content_clicks > 0 THEN (am.meta_content_leads::numeric / am.meta_content_clicks) * 100 ELSE 0 END\n            ),\n            'other', jsonb_build_object(\n                'spend', COALESCE(am.meta_other_spend, 0),\n                'clicks', COALESCE(am.meta_other_clicks, 0),\n                'impressions', COALESCE(am.meta_other_impressions, 0),\n                'leads', COALESCE(am.meta_other_leads, 0),\n                'purchases', COALESCE(am.meta_other_purchases, 0),\n                'cpc', CASE WHEN am.meta_other_clicks > 0 THEN am.meta_other_spend / am.meta_other_clicks ELSE 0 END,\n                'cpm', CASE WHEN am.meta_other_impressions > 0 THEN (am.meta_other_spend / am.meta_other_impressions) * 1000 ELSE 0 END,\n                'ctr', CASE WHEN am.meta_other_impressions > 0 THEN (am.meta_other_clicks::numeric / am.meta_other_impressions) * 100 ELSE 0 END,\n                'cpp', CASE WHEN am.meta_other_purchases > 0 THEN am.meta_other_spend / am.meta_other_purchases ELSE 0 END,\n                'cpl', CASE WHEN am.meta_other_leads > 0 THEN am.meta_other_spend / am.meta_other_leads ELSE 0 END,\n                'salesRate', CASE WHEN am.meta_other_leads > 0 THEN (am.meta_other_purchases::numeric / am.meta_other_leads) * 100 ELSE 0 END,\n                'leadRate', CASE WHEN am.meta_other_clicks > 0 THEN (am.meta_other_leads::numeric / am.meta_other_clicks) * 100 ELSE 0 END\n            )\n        ),\n        'googlePerformance', jsonb_build_object(\n            'spend', COALESCE(am.google_spend, 0),\n            'clicks', COALESCE(am.google_clicks, 0),\n            'impressions', COALESCE(am.google_impressions, 0),\n            'conversions', COALESCE(am.google_conversions, 0),\n            'cpc', CASE WHEN am.google_clicks > 0 THEN am.google_spend / am.google_clicks ELSE 0 END,\n            'cpm', CASE WHEN am.google_impressions > 0 THEN (am.google_spend / am.google_impressions) * 1000 ELSE 0 END,\n            'ctr', CASE WHEN am.google_impressions > 0 THEN (am.google_clicks::numeric / am.google_impressions) * 100 ELSE 0 END\n        ),\n        'vslPerformance', jsonb_build_object(\n            'watched5Percent', COALESCE(vm.vsl_5_percent, 0),\n            'watched25Percent', COALESCE(vm.vsl_25_percent, 0),\n            'watched50Percent', COALESCE(vm.vsl_50_percent, 0),\n            'watched95Percent', COALESCE(vm.vsl_95_percent, 0),\n            -- Drop-off percentages\n            'dropoff5to25', CASE WHEN vm.vsl_5_percent > 0 THEN ((1 - vm.vsl_25_percent::numeric / vm.vsl_5_percent) * 100) ELSE 0 END,\n            'dropoff25to50', CASE WHEN vm.vsl_25_percent > 0 THEN ((1 - vm.vsl_50_percent::numeric / vm.vsl_25_percent) * 100) ELSE 0 END,\n            'dropoff50to95', CASE WHEN vm.vsl_50_percent > 0 THEN ((1 - vm.vsl_95_percent::numeric / vm.vsl_50_percent) * 100) ELSE 0 END,\n            -- Purchases from VSL viewers\n            'purchasesFromVslViewers', COALESCE(vm.purchases_from_vsl_viewers, 0),\n            -- Conversion rate: purchases from VSL viewers / VSL 50% viewers\n            'conversionRate', CASE WHEN vm.vsl_50_percent > 0 THEN (vm.purchases_from_vsl_viewers::numeric / vm.vsl_50_percent) * 100 ELSE 0 END\n        )\n    ) INTO v_result\n    FROM lead_metrics lm\n    CROSS JOIN product_sales ps\n    CROSS JOIN engagement_metrics em\n    CROSS JOIN ad_metrics am\n    CROSS JOIN vsl_metrics vm;\n    \n    RETURN v_result;\nEND;\n$function$;",
  "returncode": 1,
  "logs": [
    "ERROR 1064 (42000) at line 11: You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 13 near \"FUNCTION IF EXISTS get_dashboard_metrics(date, date)\""
  ]
}