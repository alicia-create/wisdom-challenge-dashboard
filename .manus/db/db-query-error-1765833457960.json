{
  "query": "DROP FUNCTION IF EXISTS get_dashboard_metrics(DATE, DATE);\n\nCREATE OR REPLACE FUNCTION get_dashboard_metrics(\n    p_start_date DATE DEFAULT CURRENT_DATE - INTERVAL '30 days',\n    p_end_date DATE DEFAULT CURRENT_DATE\n)\nRETURNS JSONB\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    v_result JSONB;\n    -- Total metrics\n    v_total_leads INT;\n    v_wisdom_sales INT;\n    v_kingdom_seekers INT;\n    v_manychat_connected INT;\n    v_bot_alerts INT;\n    v_welcome_email_clicks INT;\n    -- Paid funnel\n    v_paid_leads INT;\n    v_paid_wisdom_sales INT;\n    v_paid_kingdom_seekers INT;\n    v_paid_manychat INT;\n    v_paid_bot_alerts INT;\n    v_paid_welcome_clicks INT;\n    -- Organic funnel\n    v_organic_leads INT;\n    v_organic_wisdom_sales INT;\n    v_organic_kingdom_seekers INT;\n    v_organic_manychat INT;\n    v_organic_bot_alerts INT;\n    v_organic_welcome_clicks INT;\n    -- Financial\n    v_total_spend NUMERIC;\n    v_total_revenue NUMERIC;\n    v_leads_sales_spend NUMERIC;\n    -- Ad Performance\n    v_link_clicks INT;\n    v_landing_page_views INT;\n    -- Meta totals\n    v_meta_spend NUMERIC;\n    v_meta_clicks INT;\n    v_meta_impressions BIGINT;\n    v_meta_landing_page_views INT;\n    v_meta_leads INT;\n    v_meta_purchases INT;\n    -- Meta campaign breakdown\n    v_meta_sales_spend NUMERIC;\n    v_meta_sales_clicks INT;\n    v_meta_sales_impressions BIGINT;\n    v_meta_sales_leads INT;\n    v_meta_sales_purchases INT;\n    v_meta_leads_spend NUMERIC;\n    v_meta_leads_clicks INT;\n    v_meta_leads_impressions BIGINT;\n    v_meta_leads_leads INT;\n    v_meta_leads_purchases INT;\n    v_meta_retargeting_spend NUMERIC;\n    v_meta_retargeting_clicks INT;\n    v_meta_retargeting_impressions BIGINT;\n    v_meta_retargeting_leads INT;\n    v_meta_retargeting_purchases INT;\n    v_meta_content_spend NUMERIC;\n    v_meta_content_clicks INT;\n    v_meta_content_impressions BIGINT;\n    v_meta_content_leads INT;\n    v_meta_content_purchases INT;\n    v_meta_other_spend NUMERIC;\n    v_meta_other_clicks INT;\n    v_meta_other_impressions BIGINT;\n    v_meta_other_leads INT;\n    v_meta_other_purchases INT;\n    -- VSL metrics\n    v_vsl_5_percent INT;\n    v_vsl_25_percent INT;\n    v_vsl_50_percent INT;\n    v_vsl_95_percent INT;\n    v_paid_vsl_5_percent INT;\n    v_paid_vsl_25_percent INT;\n    v_paid_vsl_50_percent INT;\n    v_paid_vsl_95_percent INT;\n    v_organic_vsl_5_percent INT;\n    v_organic_vsl_25_percent INT;\n    v_organic_vsl_50_percent INT;\n    v_organic_vsl_95_percent INT;\nBEGIN\n    -- Initialize all variables to 0\n    v_total_leads := 0; v_wisdom_sales := 0; v_kingdom_seekers := 0;\n    v_manychat_connected := 0; v_bot_alerts := 0; v_welcome_email_clicks := 0;\n    v_paid_leads := 0; v_paid_wisdom_sales := 0; v_paid_kingdom_seekers := 0;\n    v_paid_manychat := 0; v_paid_bot_alerts := 0; v_paid_welcome_clicks := 0;\n    v_organic_leads := 0; v_organic_wisdom_sales := 0; v_organic_kingdom_seekers := 0;\n    v_organic_manychat := 0; v_organic_bot_alerts := 0; v_organic_welcome_clicks := 0;\n    v_total_spend := 0; v_total_revenue := 0; v_leads_sales_spend := 0;\n    v_link_clicks := 0; v_landing_page_views := 0;\n    v_meta_spend := 0; v_meta_clicks := 0; v_meta_impressions := 0;\n    v_meta_landing_page_views := 0; v_meta_leads := 0; v_meta_purchases := 0;\n    v_meta_sales_spend := 0; v_meta_sales_clicks := 0; v_meta_sales_impressions := 0;\n    v_meta_sales_leads := 0; v_meta_sales_purchases := 0;\n    v_meta_leads_spend := 0; v_meta_leads_clicks := 0; v_meta_leads_impressions := 0;\n    v_meta_leads_leads := 0; v_meta_leads_purchases := 0;\n    v_meta_retargeting_spend := 0; v_meta_retargeting_clicks := 0; v_meta_retargeting_impressions := 0;\n    v_meta_retargeting_leads := 0; v_meta_retargeting_purchases := 0;\n    v_meta_content_spend := 0; v_meta_content_clicks := 0; v_meta_content_impressions := 0;\n    v_meta_content_leads := 0; v_meta_content_purchases := 0;\n    v_meta_other_spend := 0; v_meta_other_clicks := 0; v_meta_other_impressions := 0;\n    v_meta_other_leads := 0; v_meta_other_purchases := 0;\n    v_vsl_5_percent := 0; v_vsl_25_percent := 0; v_vsl_50_percent := 0; v_vsl_95_percent := 0;\n    v_paid_vsl_5_percent := 0; v_paid_vsl_25_percent := 0; v_paid_vsl_50_percent := 0; v_paid_vsl_95_percent := 0;\n    v_organic_vsl_5_percent := 0; v_organic_vsl_25_percent := 0; v_organic_vsl_50_percent := 0; v_organic_vsl_95_percent := 0;\n\n    -- TOTAL LEADS (wisdom funnel)\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_total_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID LEADS\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_paid_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC LEADS\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_organic_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- WISDOM SALES\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Wisdom Sales\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_paid_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Wisdom Sales\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_organic_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- KINGDOM SEEKERS (product_id = 8)\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Kingdom Seekers\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_paid_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Kingdom Seekers\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_organic_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- MANYCHAT CONNECTED\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_manychat_connected\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID ManyChat\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_paid_manychat\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC ManyChat\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_organic_manychat\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- BOT ALERTS\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Bot Alerts\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_paid_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Bot Alerts\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_organic_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae3\n          WHERE ae3.contact_id = c.id\n            AND ae3.name = 'form.submitted'\n            AND ae3.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- WELCOME EMAIL CLICKS\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_welcome_email_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Welcome Email Clicks\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_paid_welcome_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Welcome Email Clicks\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_organic_welcome_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae3\n          WHERE ae3.contact_id = c.id\n            AND ae3.name = 'form.submitted'\n            AND ae3.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- REVENUE\n    SELECT COALESCE(SUM(oi.amount), 0)\n    INTO v_total_revenue\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id IN (1, 2, 4, 8)\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- Total spend and clicks\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(landing_page_views), 0)\n    INTO v_total_spend, v_link_clicks, v_landing_page_views\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date;\n    \n    -- Spend from LEADS and SALES campaigns only (for CPL/CPP/ROAS)\n    SELECT COALESCE(SUM(spend), 0)\n    INTO v_leads_sales_spend\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND (campaign_name ILIKE '%LEADS%' OR campaign_name ILIKE '%SALES%');\n    \n    -- META PERFORMANCE\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(landing_page_views), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_spend, v_meta_clicks, v_meta_impressions, v_meta_landing_page_views, v_meta_leads, v_meta_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date AND platform ILIKE 'meta';\n    \n    -- META CAMPAIGN BREAKDOWN - SALES\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_sales_spend, v_meta_sales_clicks, v_meta_sales_impressions, v_meta_sales_leads, v_meta_sales_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%SALES%';\n    \n    -- META CAMPAIGN BREAKDOWN - LEADS\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_leads_spend, v_meta_leads_clicks, v_meta_leads_impressions, v_meta_leads_leads, v_meta_leads_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%LEADS%'\n      AND campaign_name NOT ILIKE '%SALES%';\n    \n    -- META CAMPAIGN BREAKDOWN - RETARGETING\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_retargeting_spend, v_meta_retargeting_clicks, v_meta_retargeting_impressions, v_meta_retargeting_leads, v_meta_retargeting_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%RETARGETING%';\n    \n    -- META CAMPAIGN BREAKDOWN - CONTENT\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_content_spend, v_meta_content_clicks, v_meta_content_impressions, v_meta_content_leads, v_meta_content_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%CONTENT%';\n    \n    -- META CAMPAIGN BREAKDOWN - OTHER\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_other_spend, v_meta_other_clicks, v_meta_other_impressions, v_meta_other_leads, v_meta_other_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name NOT ILIKE '%SALES%'\n      AND campaign_name NOT ILIKE '%LEADS%'\n      AND campaign_name NOT ILIKE '%RETARGETING%'\n      AND campaign_name NOT ILIKE '%CONTENT%';\n    \n    -- VSL METRICS - 5%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_5_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%5%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 25%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_25_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%25%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 50%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_50_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%50%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 95%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_95_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%95%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- Build result\n    v_result := jsonb_build_object(\n        'dateRange', jsonb_build_object(\n            'startDate', p_start_date,\n            'endDate', p_end_date\n        ),\n        'kpis', jsonb_build_object(\n            'totalLeads', v_total_leads,\n            'wisdomSales', v_wisdom_sales,\n            'kingdomSeekerTrials', v_kingdom_seekers,\n            'manychatConnected', v_manychat_connected,\n            'botAlertsSubscribed', v_bot_alerts,\n            'welcomeEmailClicks', v_welcome_email_clicks,\n            'totalSpend', ROUND(v_total_spend::NUMERIC, 2),\n            'leadsSalesSpend', ROUND(v_leads_sales_spend::NUMERIC, 2),\n            'totalRevenue', ROUND(v_total_revenue::NUMERIC, 2),\n            'linkClicks', v_link_clicks,\n            'landingPageViews', v_landing_page_views,\n            'cpl', CASE WHEN v_paid_leads > 0 THEN ROUND((v_leads_sales_spend / v_paid_leads)::NUMERIC, 2) ELSE 0 END,\n            'cpp', CASE WHEN v_paid_wisdom_sales > 0 THEN ROUND((v_leads_sales_spend / v_paid_wisdom_sales)::NUMERIC, 2) ELSE 0 END,\n            'aov', CASE WHEN v_wisdom_sales > 0 THEN ROUND((v_total_revenue / v_wisdom_sales)::NUMERIC, 2) ELSE 0 END,\n            'roas', CASE WHEN v_leads_sales_spend > 0 THEN ROUND((v_total_revenue / v_leads_sales_spend)::NUMERIC, 2) ELSE 0 END,\n            'wisdomConversion', CASE WHEN v_total_leads > 0 THEN ROUND((v_wisdom_sales::NUMERIC / v_total_leads * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'paidAdsFunnel', jsonb_build_object(\n            'leads', v_paid_leads,\n            'wisdomSales', v_paid_wisdom_sales,\n            'kingdomSeekers', v_paid_kingdom_seekers,\n            'manychatConnected', v_paid_manychat,\n            'botAlertsSubscribed', v_paid_bot_alerts,\n            'welcomeEmailClicks', v_paid_welcome_clicks,\n            'leadToWisdomRate', CASE WHEN v_paid_leads > 0 THEN ROUND((v_paid_wisdom_sales::NUMERIC / v_paid_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'wisdomToKingdomRate', CASE WHEN v_paid_wisdom_sales > 0 THEN ROUND((v_paid_kingdom_seekers::NUMERIC / v_paid_wisdom_sales * 100)::NUMERIC, 2) ELSE 0 END,\n            'leadsToManychatRate', CASE WHEN v_paid_leads > 0 THEN ROUND((v_paid_manychat::NUMERIC / v_paid_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'manychatToBotAlertsRate', CASE WHEN v_paid_manychat > 0 THEN ROUND((v_paid_bot_alerts::NUMERIC / v_paid_manychat * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'organicFunnel', jsonb_build_object(\n            'leads', v_organic_leads,\n            'wisdomSales', v_organic_wisdom_sales,\n            'kingdomSeekers', v_organic_kingdom_seekers,\n            'manychatConnected', v_organic_manychat,\n            'botAlertsSubscribed', v_organic_bot_alerts,\n            'welcomeEmailClicks', v_organic_welcome_clicks,\n            'leadToWisdomRate', CASE WHEN v_organic_leads > 0 THEN ROUND((v_organic_wisdom_sales::NUMERIC / v_organic_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'wisdomToKingdomRate', CASE WHEN v_organic_wisdom_sales > 0 THEN ROUND((v_organic_kingdom_seekers::NUMERIC / v_organic_wisdom_sales * 100)::NUMERIC, 2) ELSE 0 END,\n            'leadsToManychatRate', CASE WHEN v_organic_leads > 0 THEN ROUND((v_organic_manychat::NUMERIC / v_organic_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'manychatToBotAlertsRate', CASE WHEN v_organic_manychat > 0 THEN ROUND((v_organic_bot_alerts::NUMERIC / v_organic_manychat * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'metaPerformance', jsonb_build_object(\n            'spend', ROUND(v_meta_spend::NUMERIC, 2),\n            'purchases', v_meta_purchases,\n            'cpp', CASE WHEN v_meta_purchases > 0 THEN ROUND((v_meta_spend / v_meta_purchases)::NUMERIC, 2) ELSE 0 END,\n            'salesRate', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_purchases::NUMERIC / v_meta_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n            'leads', v_meta_leads,\n            'cpl', CASE WHEN v_meta_leads > 0 THEN ROUND((v_meta_spend / v_meta_leads)::NUMERIC, 2) ELSE 0 END,\n            'leadRate', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_leads::NUMERIC / v_meta_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n            'clicks', v_meta_clicks,\n            'cpc', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_spend / v_meta_clicks)::NUMERIC, 2) ELSE 0 END,\n            'ctr', CASE WHEN v_meta_impressions > 0 THEN ROUND((v_meta_clicks::NUMERIC / v_meta_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n            'cpm', CASE WHEN v_meta_impressions > 0 THEN ROUND((v_meta_spend / v_meta_impressions * 1000)::NUMERIC, 2) ELSE 0 END,\n            'impressions', v_meta_impressions,\n            'landingPageViews', v_meta_landing_page_views\n        ),\n        'metaCampaignBreakdown', jsonb_build_object(\n            'sales', jsonb_build_object(\n                'spend', ROUND(v_meta_sales_spend::NUMERIC, 2),\n                'purchases', v_meta_sales_purchases,\n                'cpp', CASE WHEN v_meta_sales_purchases > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_purchases::NUMERIC / v_meta_sales_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_sales_leads,\n                'cpl', CASE WHEN v_meta_sales_leads > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_leads::NUMERIC / v_meta_sales_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_sales_clicks,\n                'cpc', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_sales_impressions > 0 THEN ROUND((v_meta_sales_clicks::NUMERIC / v_meta_sales_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_sales_impressions > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'leads', jsonb_build_object(\n                'spend', ROUND(v_meta_leads_spend::NUMERIC, 2),\n                'purchases', v_meta_leads_purchases,\n                'cpp', CASE WHEN v_meta_leads_purchases > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_purchases::NUMERIC / v_meta_leads_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_leads_leads,\n                'cpl', CASE WHEN v_meta_leads_leads > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_leads::NUMERIC / v_meta_leads_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_leads_clicks,\n                'cpc', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_leads_impressions > 0 THEN ROUND((v_meta_leads_clicks::NUMERIC / v_meta_leads_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_leads_impressions > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'retargeting', jsonb_build_object(\n                'spend', ROUND(v_meta_retargeting_spend::NUMERIC, 2),\n                'purchases', v_meta_retargeting_purchases,\n                'cpp', CASE WHEN v_meta_retargeting_purchases > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_purchases::NUMERIC / v_meta_retargeting_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_retargeting_leads,\n                'cpl', CASE WHEN v_meta_retargeting_leads > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_leads::NUMERIC / v_meta_retargeting_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_retargeting_clicks,\n                'cpc', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_retargeting_impressions > 0 THEN ROUND((v_meta_retargeting_clicks::NUMERIC / v_meta_retargeting_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_retargeting_impressions > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'content', jsonb_build_object(\n                'spend', ROUND(v_meta_content_spend::NUMERIC, 2),\n                'purchases', v_meta_content_purchases,\n                'cpp', CASE WHEN v_meta_content_purchases > 0 THEN ROUND((v_meta_content_spend / v_meta_content_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_purchases::NUMERIC / v_meta_content_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_content_leads,\n                'cpl', CASE WHEN v_meta_content_leads > 0 THEN ROUND((v_meta_content_spend / v_meta_content_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_leads::NUMERIC / v_meta_content_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_content_clicks,\n                'cpc', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_spend / v_meta_content_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_content_impressions > 0 THEN ROUND((v_meta_content_clicks::NUMERIC / v_meta_content_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_content_impressions > 0 THEN ROUND((v_meta_content_spend / v_meta_content_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'other', jsonb_build_object(\n                'spend', ROUND(v_meta_other_spend::NUMERIC, 2),\n                'purchases', v_meta_other_purchases,\n                'cpp', CASE WHEN v_meta_other_purchases > 0 THEN ROUND((v_meta_other_spend / v_meta_other_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_purchases::NUMERIC / v_meta_other_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_other_leads,\n                'cpl', CASE WHEN v_meta_other_leads > 0 THEN ROUND((v_meta_other_spend / v_meta_other_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_leads::NUMERIC / v_meta_other_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_other_clicks,\n                'cpc', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_spend / v_meta_other_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_other_impressions > 0 THEN ROUND((v_meta_other_clicks::NUMERIC / v_meta_other_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_other_impressions > 0 THEN ROUND((v_meta_other_spend / v_meta_other_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            )\n        ),\n        'vslMetrics', jsonb_build_object(\n            'total', jsonb_build_object(\n                'vsl5Percent', v_vsl_5_percent,\n                'vsl25Percent', v_vsl_25_percent,\n                'vsl50Percent', v_vsl_50_percent,\n                'vsl95Percent', v_vsl_95_percent,\n                'dropOff5Percent', CASE WHEN v_total_leads > 0 THEN ROUND(((v_total_leads - v_vsl_5_percent)::NUMERIC / v_total_leads * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff25Percent', CASE WHEN v_vsl_5_percent > 0 THEN ROUND(((v_vsl_5_percent - v_vsl_25_percent)::NUMERIC / v_vsl_5_percent * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff50Percent', CASE WHEN v_vsl_25_percent > 0 THEN ROUND(((v_vsl_25_percent - v_vsl_50_percent)::NUMERIC / v_vsl_25_percent * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff95Percent', CASE WHEN v_vsl_50_percent > 0 THEN ROUND(((v_vsl_50_percent - v_vsl_95_percent)::NUMERIC / v_vsl_50_percent * 100)::NUMERIC, 2) ELSE 0 END\n            ),\n            'paid', jsonb_build_object(\n                'vsl5Percent', v_paid_vsl_5_percent,\n                'vsl25Percent', v_paid_vsl_25_percent,\n                'vsl50Percent', v_paid_vsl_50_percent,\n                'vsl95Percent', v_paid_vsl_95_percent\n            ),\n            'organic', jsonb_build_object(\n                'vsl5Percent', v_organic_vsl_5_percent,\n                'vsl25Percent', v_organic_vsl_25_percent,\n                'vsl50Percent', v_organic_vsl_50_percent,\n                'vsl95Percent', v_organic_vsl_95_percent\n            )\n        )\n    );\n    \n    RETURN v_result;\nEND;\n$$;\n\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO authenticated;\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO anon;\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO service_role;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 2j9rVuZuRurkhgi.64ac36f98b86 --database DEFt9ARHDVCZprKAKnwLBw --execute DROP FUNCTION IF EXISTS get_dashboard_metrics(DATE, DATE);\n\nCREATE OR REPLACE FUNCTION get_dashboard_metrics(\n    p_start_date DATE DEFAULT CURRENT_DATE - INTERVAL '30 days',\n    p_end_date DATE DEFAULT CURRENT_DATE\n)\nRETURNS JSONB\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n    v_result JSONB;\n    -- Total metrics\n    v_total_leads INT;\n    v_wisdom_sales INT;\n    v_kingdom_seekers INT;\n    v_manychat_connected INT;\n    v_bot_alerts INT;\n    v_welcome_email_clicks INT;\n    -- Paid funnel\n    v_paid_leads INT;\n    v_paid_wisdom_sales INT;\n    v_paid_kingdom_seekers INT;\n    v_paid_manychat INT;\n    v_paid_bot_alerts INT;\n    v_paid_welcome_clicks INT;\n    -- Organic funnel\n    v_organic_leads INT;\n    v_organic_wisdom_sales INT;\n    v_organic_kingdom_seekers INT;\n    v_organic_manychat INT;\n    v_organic_bot_alerts INT;\n    v_organic_welcome_clicks INT;\n    -- Financial\n    v_total_spend NUMERIC;\n    v_total_revenue NUMERIC;\n    v_leads_sales_spend NUMERIC;\n    -- Ad Performance\n    v_link_clicks INT;\n    v_landing_page_views INT;\n    -- Meta totals\n    v_meta_spend NUMERIC;\n    v_meta_clicks INT;\n    v_meta_impressions BIGINT;\n    v_meta_landing_page_views INT;\n    v_meta_leads INT;\n    v_meta_purchases INT;\n    -- Meta campaign breakdown\n    v_meta_sales_spend NUMERIC;\n    v_meta_sales_clicks INT;\n    v_meta_sales_impressions BIGINT;\n    v_meta_sales_leads INT;\n    v_meta_sales_purchases INT;\n    v_meta_leads_spend NUMERIC;\n    v_meta_leads_clicks INT;\n    v_meta_leads_impressions BIGINT;\n    v_meta_leads_leads INT;\n    v_meta_leads_purchases INT;\n    v_meta_retargeting_spend NUMERIC;\n    v_meta_retargeting_clicks INT;\n    v_meta_retargeting_impressions BIGINT;\n    v_meta_retargeting_leads INT;\n    v_meta_retargeting_purchases INT;\n    v_meta_content_spend NUMERIC;\n    v_meta_content_clicks INT;\n    v_meta_content_impressions BIGINT;\n    v_meta_content_leads INT;\n    v_meta_content_purchases INT;\n    v_meta_other_spend NUMERIC;\n    v_meta_other_clicks INT;\n    v_meta_other_impressions BIGINT;\n    v_meta_other_leads INT;\n    v_meta_other_purchases INT;\n    -- VSL metrics\n    v_vsl_5_percent INT;\n    v_vsl_25_percent INT;\n    v_vsl_50_percent INT;\n    v_vsl_95_percent INT;\n    v_paid_vsl_5_percent INT;\n    v_paid_vsl_25_percent INT;\n    v_paid_vsl_50_percent INT;\n    v_paid_vsl_95_percent INT;\n    v_organic_vsl_5_percent INT;\n    v_organic_vsl_25_percent INT;\n    v_organic_vsl_50_percent INT;\n    v_organic_vsl_95_percent INT;\nBEGIN\n    -- Initialize all variables to 0\n    v_total_leads := 0; v_wisdom_sales := 0; v_kingdom_seekers := 0;\n    v_manychat_connected := 0; v_bot_alerts := 0; v_welcome_email_clicks := 0;\n    v_paid_leads := 0; v_paid_wisdom_sales := 0; v_paid_kingdom_seekers := 0;\n    v_paid_manychat := 0; v_paid_bot_alerts := 0; v_paid_welcome_clicks := 0;\n    v_organic_leads := 0; v_organic_wisdom_sales := 0; v_organic_kingdom_seekers := 0;\n    v_organic_manychat := 0; v_organic_bot_alerts := 0; v_organic_welcome_clicks := 0;\n    v_total_spend := 0; v_total_revenue := 0; v_leads_sales_spend := 0;\n    v_link_clicks := 0; v_landing_page_views := 0;\n    v_meta_spend := 0; v_meta_clicks := 0; v_meta_impressions := 0;\n    v_meta_landing_page_views := 0; v_meta_leads := 0; v_meta_purchases := 0;\n    v_meta_sales_spend := 0; v_meta_sales_clicks := 0; v_meta_sales_impressions := 0;\n    v_meta_sales_leads := 0; v_meta_sales_purchases := 0;\n    v_meta_leads_spend := 0; v_meta_leads_clicks := 0; v_meta_leads_impressions := 0;\n    v_meta_leads_leads := 0; v_meta_leads_purchases := 0;\n    v_meta_retargeting_spend := 0; v_meta_retargeting_clicks := 0; v_meta_retargeting_impressions := 0;\n    v_meta_retargeting_leads := 0; v_meta_retargeting_purchases := 0;\n    v_meta_content_spend := 0; v_meta_content_clicks := 0; v_meta_content_impressions := 0;\n    v_meta_content_leads := 0; v_meta_content_purchases := 0;\n    v_meta_other_spend := 0; v_meta_other_clicks := 0; v_meta_other_impressions := 0;\n    v_meta_other_leads := 0; v_meta_other_purchases := 0;\n    v_vsl_5_percent := 0; v_vsl_25_percent := 0; v_vsl_50_percent := 0; v_vsl_95_percent := 0;\n    v_paid_vsl_5_percent := 0; v_paid_vsl_25_percent := 0; v_paid_vsl_50_percent := 0; v_paid_vsl_95_percent := 0;\n    v_organic_vsl_5_percent := 0; v_organic_vsl_25_percent := 0; v_organic_vsl_50_percent := 0; v_organic_vsl_95_percent := 0;\n\n    -- TOTAL LEADS (wisdom funnel)\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_total_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID LEADS\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_paid_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC LEADS\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_organic_leads\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- WISDOM SALES\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Wisdom Sales\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_paid_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Wisdom Sales\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_organic_wisdom_sales\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 1\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- KINGDOM SEEKERS (product_id = 8)\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Kingdom Seekers\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_paid_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Kingdom Seekers\n    SELECT COUNT(DISTINCT o.id)\n    INTO v_organic_kingdom_seekers\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id = 8\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- MANYCHAT CONNECTED\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_manychat_connected\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID ManyChat\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_paid_manychat\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC ManyChat\n    SELECT COUNT(DISTINCT c.id)\n    INTO v_organic_manychat\n    FROM contacts c\n    WHERE c.created_at >= p_start_date\n      AND c.created_at < p_end_date + INTERVAL '1 day'\n      AND c.manychat_id IS NOT NULL\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- BOT ALERTS\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Bot Alerts\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_paid_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Bot Alerts\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_organic_bot_alerts\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.value = 'gold.ntn.request_accepted'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae3\n          WHERE ae3.contact_id = c.id\n            AND ae3.name = 'form.submitted'\n            AND ae3.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- WELCOME EMAIL CLICKS\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_welcome_email_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- PAID Welcome Email Clicks\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_paid_welcome_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- ORGANIC Welcome Email Clicks\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_organic_welcome_clicks\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'keap.add_tag'\n      AND ae.value ILIKE '%Clicked NTN In Email%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%31daywisdomchallenge.com%'\n      )\n      AND NOT EXISTS (\n          SELECT 1 FROM analytics_events ae3\n          WHERE ae3.contact_id = c.id\n            AND ae3.name = 'form.submitted'\n            AND ae3.comment ILIKE '%31daywisdom.com%'\n      );\n    \n    -- REVENUE\n    SELECT COALESCE(SUM(oi.amount), 0)\n    INTO v_total_revenue\n    FROM orders o\n    JOIN order_items oi ON o.id = oi.order_id\n    JOIN contacts c ON o.contact_id = c.id\n    WHERE o.created_at >= p_start_date\n      AND o.created_at < p_end_date + INTERVAL '1 day'\n      AND oi.product_id IN (1, 2, 4, 8)\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae\n          WHERE ae.contact_id = c.id\n            AND ae.name = 'form.submitted'\n            AND ae.comment ILIKE '%wisdom%'\n      );\n    \n    -- Total spend and clicks\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(landing_page_views), 0)\n    INTO v_total_spend, v_link_clicks, v_landing_page_views\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date;\n    \n    -- Spend from LEADS and SALES campaigns only (for CPL/CPP/ROAS)\n    SELECT COALESCE(SUM(spend), 0)\n    INTO v_leads_sales_spend\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND (campaign_name ILIKE '%LEADS%' OR campaign_name ILIKE '%SALES%');\n    \n    -- META PERFORMANCE\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(landing_page_views), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_spend, v_meta_clicks, v_meta_impressions, v_meta_landing_page_views, v_meta_leads, v_meta_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date AND platform ILIKE 'meta';\n    \n    -- META CAMPAIGN BREAKDOWN - SALES\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_sales_spend, v_meta_sales_clicks, v_meta_sales_impressions, v_meta_sales_leads, v_meta_sales_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%SALES%';\n    \n    -- META CAMPAIGN BREAKDOWN - LEADS\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_leads_spend, v_meta_leads_clicks, v_meta_leads_impressions, v_meta_leads_leads, v_meta_leads_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%LEADS%'\n      AND campaign_name NOT ILIKE '%SALES%';\n    \n    -- META CAMPAIGN BREAKDOWN - RETARGETING\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_retargeting_spend, v_meta_retargeting_clicks, v_meta_retargeting_impressions, v_meta_retargeting_leads, v_meta_retargeting_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%RETARGETING%';\n    \n    -- META CAMPAIGN BREAKDOWN - CONTENT\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_content_spend, v_meta_content_clicks, v_meta_content_impressions, v_meta_content_leads, v_meta_content_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name ILIKE '%CONTENT%';\n    \n    -- META CAMPAIGN BREAKDOWN - OTHER\n    SELECT \n        COALESCE(SUM(spend), 0),\n        COALESCE(SUM(link_clicks), 0),\n        COALESCE(SUM(impressions), 0),\n        COALESCE(SUM(reported_leads), 0),\n        COALESCE(SUM(reported_purchases), 0)\n    INTO v_meta_other_spend, v_meta_other_clicks, v_meta_other_impressions, v_meta_other_leads, v_meta_other_purchases\n    FROM ad_performance\n    WHERE date >= p_start_date AND date <= p_end_date \n      AND platform ILIKE 'meta'\n      AND campaign_name NOT ILIKE '%SALES%'\n      AND campaign_name NOT ILIKE '%LEADS%'\n      AND campaign_name NOT ILIKE '%RETARGETING%'\n      AND campaign_name NOT ILIKE '%CONTENT%';\n    \n    -- VSL METRICS - 5%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_5_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%5%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 25%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_25_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%25%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 50%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_50_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%50%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- VSL 95%\n    SELECT COUNT(DISTINCT ae.contact_id)\n    INTO v_vsl_95_percent\n    FROM analytics_events ae\n    JOIN contacts c ON ae.contact_id = c.id\n    WHERE ae.timestamp >= p_start_date\n      AND ae.timestamp < p_end_date + INTERVAL '1 day'\n      AND ae.name = 'vidalytics.view_video'\n      AND ae.value ILIKE '%95%'\n      AND EXISTS (\n          SELECT 1 FROM analytics_events ae2\n          WHERE ae2.contact_id = c.id\n            AND ae2.name = 'form.submitted'\n            AND ae2.comment ILIKE '%wisdom%'\n      );\n    \n    -- Build result\n    v_result := jsonb_build_object(\n        'dateRange', jsonb_build_object(\n            'startDate', p_start_date,\n            'endDate', p_end_date\n        ),\n        'kpis', jsonb_build_object(\n            'totalLeads', v_total_leads,\n            'wisdomSales', v_wisdom_sales,\n            'kingdomSeekerTrials', v_kingdom_seekers,\n            'manychatConnected', v_manychat_connected,\n            'botAlertsSubscribed', v_bot_alerts,\n            'welcomeEmailClicks', v_welcome_email_clicks,\n            'totalSpend', ROUND(v_total_spend::NUMERIC, 2),\n            'leadsSalesSpend', ROUND(v_leads_sales_spend::NUMERIC, 2),\n            'totalRevenue', ROUND(v_total_revenue::NUMERIC, 2),\n            'linkClicks', v_link_clicks,\n            'landingPageViews', v_landing_page_views,\n            'cpl', CASE WHEN v_paid_leads > 0 THEN ROUND((v_leads_sales_spend / v_paid_leads)::NUMERIC, 2) ELSE 0 END,\n            'cpp', CASE WHEN v_paid_wisdom_sales > 0 THEN ROUND((v_leads_sales_spend / v_paid_wisdom_sales)::NUMERIC, 2) ELSE 0 END,\n            'aov', CASE WHEN v_wisdom_sales > 0 THEN ROUND((v_total_revenue / v_wisdom_sales)::NUMERIC, 2) ELSE 0 END,\n            'roas', CASE WHEN v_leads_sales_spend > 0 THEN ROUND((v_total_revenue / v_leads_sales_spend)::NUMERIC, 2) ELSE 0 END,\n            'wisdomConversion', CASE WHEN v_total_leads > 0 THEN ROUND((v_wisdom_sales::NUMERIC / v_total_leads * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'paidAdsFunnel', jsonb_build_object(\n            'leads', v_paid_leads,\n            'wisdomSales', v_paid_wisdom_sales,\n            'kingdomSeekers', v_paid_kingdom_seekers,\n            'manychatConnected', v_paid_manychat,\n            'botAlertsSubscribed', v_paid_bot_alerts,\n            'welcomeEmailClicks', v_paid_welcome_clicks,\n            'leadToWisdomRate', CASE WHEN v_paid_leads > 0 THEN ROUND((v_paid_wisdom_sales::NUMERIC / v_paid_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'wisdomToKingdomRate', CASE WHEN v_paid_wisdom_sales > 0 THEN ROUND((v_paid_kingdom_seekers::NUMERIC / v_paid_wisdom_sales * 100)::NUMERIC, 2) ELSE 0 END,\n            'leadsToManychatRate', CASE WHEN v_paid_leads > 0 THEN ROUND((v_paid_manychat::NUMERIC / v_paid_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'manychatToBotAlertsRate', CASE WHEN v_paid_manychat > 0 THEN ROUND((v_paid_bot_alerts::NUMERIC / v_paid_manychat * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'organicFunnel', jsonb_build_object(\n            'leads', v_organic_leads,\n            'wisdomSales', v_organic_wisdom_sales,\n            'kingdomSeekers', v_organic_kingdom_seekers,\n            'manychatConnected', v_organic_manychat,\n            'botAlertsSubscribed', v_organic_bot_alerts,\n            'welcomeEmailClicks', v_organic_welcome_clicks,\n            'leadToWisdomRate', CASE WHEN v_organic_leads > 0 THEN ROUND((v_organic_wisdom_sales::NUMERIC / v_organic_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'wisdomToKingdomRate', CASE WHEN v_organic_wisdom_sales > 0 THEN ROUND((v_organic_kingdom_seekers::NUMERIC / v_organic_wisdom_sales * 100)::NUMERIC, 2) ELSE 0 END,\n            'leadsToManychatRate', CASE WHEN v_organic_leads > 0 THEN ROUND((v_organic_manychat::NUMERIC / v_organic_leads * 100)::NUMERIC, 2) ELSE 0 END,\n            'manychatToBotAlertsRate', CASE WHEN v_organic_manychat > 0 THEN ROUND((v_organic_bot_alerts::NUMERIC / v_organic_manychat * 100)::NUMERIC, 2) ELSE 0 END\n        ),\n        'metaPerformance', jsonb_build_object(\n            'spend', ROUND(v_meta_spend::NUMERIC, 2),\n            'purchases', v_meta_purchases,\n            'cpp', CASE WHEN v_meta_purchases > 0 THEN ROUND((v_meta_spend / v_meta_purchases)::NUMERIC, 2) ELSE 0 END,\n            'salesRate', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_purchases::NUMERIC / v_meta_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n            'leads', v_meta_leads,\n            'cpl', CASE WHEN v_meta_leads > 0 THEN ROUND((v_meta_spend / v_meta_leads)::NUMERIC, 2) ELSE 0 END,\n            'leadRate', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_leads::NUMERIC / v_meta_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n            'clicks', v_meta_clicks,\n            'cpc', CASE WHEN v_meta_clicks > 0 THEN ROUND((v_meta_spend / v_meta_clicks)::NUMERIC, 2) ELSE 0 END,\n            'ctr', CASE WHEN v_meta_impressions > 0 THEN ROUND((v_meta_clicks::NUMERIC / v_meta_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n            'cpm', CASE WHEN v_meta_impressions > 0 THEN ROUND((v_meta_spend / v_meta_impressions * 1000)::NUMERIC, 2) ELSE 0 END,\n            'impressions', v_meta_impressions,\n            'landingPageViews', v_meta_landing_page_views\n        ),\n        'metaCampaignBreakdown', jsonb_build_object(\n            'sales', jsonb_build_object(\n                'spend', ROUND(v_meta_sales_spend::NUMERIC, 2),\n                'purchases', v_meta_sales_purchases,\n                'cpp', CASE WHEN v_meta_sales_purchases > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_purchases::NUMERIC / v_meta_sales_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_sales_leads,\n                'cpl', CASE WHEN v_meta_sales_leads > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_leads::NUMERIC / v_meta_sales_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_sales_clicks,\n                'cpc', CASE WHEN v_meta_sales_clicks > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_sales_impressions > 0 THEN ROUND((v_meta_sales_clicks::NUMERIC / v_meta_sales_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_sales_impressions > 0 THEN ROUND((v_meta_sales_spend / v_meta_sales_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'leads', jsonb_build_object(\n                'spend', ROUND(v_meta_leads_spend::NUMERIC, 2),\n                'purchases', v_meta_leads_purchases,\n                'cpp', CASE WHEN v_meta_leads_purchases > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_purchases::NUMERIC / v_meta_leads_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_leads_leads,\n                'cpl', CASE WHEN v_meta_leads_leads > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_leads::NUMERIC / v_meta_leads_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_leads_clicks,\n                'cpc', CASE WHEN v_meta_leads_clicks > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_leads_impressions > 0 THEN ROUND((v_meta_leads_clicks::NUMERIC / v_meta_leads_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_leads_impressions > 0 THEN ROUND((v_meta_leads_spend / v_meta_leads_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'retargeting', jsonb_build_object(\n                'spend', ROUND(v_meta_retargeting_spend::NUMERIC, 2),\n                'purchases', v_meta_retargeting_purchases,\n                'cpp', CASE WHEN v_meta_retargeting_purchases > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_purchases::NUMERIC / v_meta_retargeting_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_retargeting_leads,\n                'cpl', CASE WHEN v_meta_retargeting_leads > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_leads::NUMERIC / v_meta_retargeting_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_retargeting_clicks,\n                'cpc', CASE WHEN v_meta_retargeting_clicks > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_retargeting_impressions > 0 THEN ROUND((v_meta_retargeting_clicks::NUMERIC / v_meta_retargeting_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_retargeting_impressions > 0 THEN ROUND((v_meta_retargeting_spend / v_meta_retargeting_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'content', jsonb_build_object(\n                'spend', ROUND(v_meta_content_spend::NUMERIC, 2),\n                'purchases', v_meta_content_purchases,\n                'cpp', CASE WHEN v_meta_content_purchases > 0 THEN ROUND((v_meta_content_spend / v_meta_content_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_purchases::NUMERIC / v_meta_content_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_content_leads,\n                'cpl', CASE WHEN v_meta_content_leads > 0 THEN ROUND((v_meta_content_spend / v_meta_content_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_leads::NUMERIC / v_meta_content_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_content_clicks,\n                'cpc', CASE WHEN v_meta_content_clicks > 0 THEN ROUND((v_meta_content_spend / v_meta_content_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_content_impressions > 0 THEN ROUND((v_meta_content_clicks::NUMERIC / v_meta_content_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_content_impressions > 0 THEN ROUND((v_meta_content_spend / v_meta_content_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            ),\n            'other', jsonb_build_object(\n                'spend', ROUND(v_meta_other_spend::NUMERIC, 2),\n                'purchases', v_meta_other_purchases,\n                'cpp', CASE WHEN v_meta_other_purchases > 0 THEN ROUND((v_meta_other_spend / v_meta_other_purchases)::NUMERIC, 2) ELSE 0 END,\n                'salesRate', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_purchases::NUMERIC / v_meta_other_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'leads', v_meta_other_leads,\n                'cpl', CASE WHEN v_meta_other_leads > 0 THEN ROUND((v_meta_other_spend / v_meta_other_leads)::NUMERIC, 2) ELSE 0 END,\n                'leadRate', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_leads::NUMERIC / v_meta_other_clicks * 100)::NUMERIC, 2) ELSE 0 END,\n                'clicks', v_meta_other_clicks,\n                'cpc', CASE WHEN v_meta_other_clicks > 0 THEN ROUND((v_meta_other_spend / v_meta_other_clicks)::NUMERIC, 2) ELSE 0 END,\n                'ctr', CASE WHEN v_meta_other_impressions > 0 THEN ROUND((v_meta_other_clicks::NUMERIC / v_meta_other_impressions * 100)::NUMERIC, 2) ELSE 0 END,\n                'cpm', CASE WHEN v_meta_other_impressions > 0 THEN ROUND((v_meta_other_spend / v_meta_other_impressions * 1000)::NUMERIC, 2) ELSE 0 END\n            )\n        ),\n        'vslMetrics', jsonb_build_object(\n            'total', jsonb_build_object(\n                'vsl5Percent', v_vsl_5_percent,\n                'vsl25Percent', v_vsl_25_percent,\n                'vsl50Percent', v_vsl_50_percent,\n                'vsl95Percent', v_vsl_95_percent,\n                'dropOff5Percent', CASE WHEN v_total_leads > 0 THEN ROUND(((v_total_leads - v_vsl_5_percent)::NUMERIC / v_total_leads * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff25Percent', CASE WHEN v_vsl_5_percent > 0 THEN ROUND(((v_vsl_5_percent - v_vsl_25_percent)::NUMERIC / v_vsl_5_percent * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff50Percent', CASE WHEN v_vsl_25_percent > 0 THEN ROUND(((v_vsl_25_percent - v_vsl_50_percent)::NUMERIC / v_vsl_25_percent * 100)::NUMERIC, 2) ELSE 0 END,\n                'dropOff95Percent', CASE WHEN v_vsl_50_percent > 0 THEN ROUND(((v_vsl_50_percent - v_vsl_95_percent)::NUMERIC / v_vsl_50_percent * 100)::NUMERIC, 2) ELSE 0 END\n            ),\n            'paid', jsonb_build_object(\n                'vsl5Percent', v_paid_vsl_5_percent,\n                'vsl25Percent', v_paid_vsl_25_percent,\n                'vsl50Percent', v_paid_vsl_50_percent,\n                'vsl95Percent', v_paid_vsl_95_percent\n            ),\n            'organic', jsonb_build_object(\n                'vsl5Percent', v_organic_vsl_5_percent,\n                'vsl25Percent', v_organic_vsl_25_percent,\n                'vsl50Percent', v_organic_vsl_50_percent,\n                'vsl95Percent', v_organic_vsl_95_percent\n            )\n        )\n    );\n    \n    RETURN v_result;\nEND;\n$$;\n\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO authenticated;\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO anon;\nGRANT EXECUTE ON FUNCTION get_dashboard_metrics(DATE, DATE) TO service_role;",
  "returncode": 1,
  "logs": [
    "ERROR 1064 (42000) at line 1: You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 13 near \"FUNCTION IF EXISTS get_dashboard_metrics(DATE, DATE)\""
  ]
}