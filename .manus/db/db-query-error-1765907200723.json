{
  "query": "CREATE OR REPLACE FUNCTION get_optimization_metrics(\n  days_back INT DEFAULT 7,\n  campaign_filter TEXT DEFAULT '31DWC2026'\n)\nRETURNS JSON\nLANGUAGE plpgsql\nAS $$\nDECLARE\n  result JSON;\n  start_date DATE;\n  yesterday_date DATE;\nBEGIN\n  start_date := CURRENT_DATE - days_back;\n  yesterday_date := CURRENT_DATE - 1;\n  \n  WITH filtered_ads AS (\n    SELECT *\n    FROM ad_performance\n    WHERE campaign_name ILIKE '%' || campaign_filter || '%'\n      AND (campaign_name LIKE '%[SALES]%' OR campaign_name LIKE '%[LEADS]%')\n      AND date >= start_date\n  ),\n  \n  ad_aggregates AS (\n    SELECT\n      ad_id,\n      ad_name,\n      adset_id,\n      adset_name,\n      campaign_id,\n      campaign_name,\n      SUM(spend) AS total_spend,\n      SUM(clicks) AS total_clicks,\n      SUM(impressions) AS total_impressions,\n      SUM(inline_link_clicks) AS total_link_clicks,\n      SUM(landing_page_views) AS total_landing_page_views,\n      SUM(reported_leads) AS total_leads,\n      SUM(reported_purchases) AS total_purchases,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(landing_page_views)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS connect_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_leads)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS lead_rate,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(reported_leads)\n        ELSE 0 \n      END AS purchase_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS click_to_purchase_rate,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(spend) / SUM(reported_leads)\n        ELSE 0 \n      END AS cpl\n    FROM filtered_ads\n    GROUP BY ad_id, ad_name, adset_id, adset_name, campaign_id, campaign_name\n  ),\n  \n  yesterday_aggregates AS (\n    SELECT\n      SUM(spend) AS spend,\n      SUM(inline_link_clicks) AS link_clicks,\n      SUM(reported_leads) AS leads,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(reported_leads)\n        ELSE 0 \n      END AS purchase_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS click_to_purchase_rate,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date = yesterday_date\n  ),\n  \n  trend_3day AS (\n    SELECT\n      date,\n      SUM(spend) AS spend,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date >= CURRENT_DATE - 3\n    GROUP BY date\n    ORDER BY date DESC\n  ),\n  \n  trend_7day AS (\n    SELECT\n      date,\n      SUM(spend) AS spend,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date >= CURRENT_DATE - 7\n    GROUP BY date\n    ORDER BY date DESC\n  )\n  \n  SELECT json_build_object(\n    'ads', (SELECT json_agg(row_to_json(ad_aggregates)) FROM ad_aggregates),\n    'yesterday', (SELECT row_to_json(yesterday_aggregates) FROM yesterday_aggregates),\n    'trend_3day', (SELECT json_agg(row_to_json(trend_3day)) FROM trend_3day),\n    'trend_7day', (SELECT json_agg(row_to_json(trend_7day)) FROM trend_7day),\n    'total_ads_analyzed', (SELECT COUNT(*) FROM ad_aggregates),\n    'date_range', json_build_object(\n      'start', start_date,\n      'end', CURRENT_DATE - 1,\n      'days', days_back\n    )\n  ) INTO result;\n  \n  RETURN result;\nEND;\n$$;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 2j9rVuZuRurkhgi.64ac36f98b86 --database DEFt9ARHDVCZprKAKnwLBw --execute CREATE OR REPLACE FUNCTION get_optimization_metrics(\n  days_back INT DEFAULT 7,\n  campaign_filter TEXT DEFAULT '31DWC2026'\n)\nRETURNS JSON\nLANGUAGE plpgsql\nAS $$\nDECLARE\n  result JSON;\n  start_date DATE;\n  yesterday_date DATE;\nBEGIN\n  start_date := CURRENT_DATE - days_back;\n  yesterday_date := CURRENT_DATE - 1;\n  \n  WITH filtered_ads AS (\n    SELECT *\n    FROM ad_performance\n    WHERE campaign_name ILIKE '%' || campaign_filter || '%'\n      AND (campaign_name LIKE '%[SALES]%' OR campaign_name LIKE '%[LEADS]%')\n      AND date >= start_date\n  ),\n  \n  ad_aggregates AS (\n    SELECT\n      ad_id,\n      ad_name,\n      adset_id,\n      adset_name,\n      campaign_id,\n      campaign_name,\n      SUM(spend) AS total_spend,\n      SUM(clicks) AS total_clicks,\n      SUM(impressions) AS total_impressions,\n      SUM(inline_link_clicks) AS total_link_clicks,\n      SUM(landing_page_views) AS total_landing_page_views,\n      SUM(reported_leads) AS total_leads,\n      SUM(reported_purchases) AS total_purchases,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(landing_page_views)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS connect_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_leads)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS lead_rate,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(reported_leads)\n        ELSE 0 \n      END AS purchase_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS click_to_purchase_rate,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(spend) / SUM(reported_leads)\n        ELSE 0 \n      END AS cpl\n    FROM filtered_ads\n    GROUP BY ad_id, ad_name, adset_id, adset_name, campaign_id, campaign_name\n  ),\n  \n  yesterday_aggregates AS (\n    SELECT\n      SUM(spend) AS spend,\n      SUM(inline_link_clicks) AS link_clicks,\n      SUM(reported_leads) AS leads,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_leads) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(reported_leads)\n        ELSE 0 \n      END AS purchase_rate,\n      CASE \n        WHEN SUM(inline_link_clicks) > 0 \n        THEN SUM(reported_purchases)::FLOAT / SUM(inline_link_clicks)\n        ELSE 0 \n      END AS click_to_purchase_rate,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date = yesterday_date\n  ),\n  \n  trend_3day AS (\n    SELECT\n      date,\n      SUM(spend) AS spend,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date >= CURRENT_DATE - 3\n    GROUP BY date\n    ORDER BY date DESC\n  ),\n  \n  trend_7day AS (\n    SELECT\n      date,\n      SUM(spend) AS spend,\n      SUM(reported_purchases) AS purchases,\n      CASE \n        WHEN SUM(reported_purchases) > 0 \n        THEN SUM(spend) / SUM(reported_purchases)\n        ELSE 0 \n      END AS cpp\n    FROM filtered_ads\n    WHERE date >= CURRENT_DATE - 7\n    GROUP BY date\n    ORDER BY date DESC\n  )\n  \n  SELECT json_build_object(\n    'ads', (SELECT json_agg(row_to_json(ad_aggregates)) FROM ad_aggregates),\n    'yesterday', (SELECT row_to_json(yesterday_aggregates) FROM yesterday_aggregates),\n    'trend_3day', (SELECT json_agg(row_to_json(trend_3day)) FROM trend_3day),\n    'trend_7day', (SELECT json_agg(row_to_json(trend_7day)) FROM trend_7day),\n    'total_ads_analyzed', (SELECT COUNT(*) FROM ad_aggregates),\n    'date_range', json_build_object(\n      'start', start_date,\n      'end', CURRENT_DATE - 1,\n      'days', days_back\n    )\n  ) INTO result;\n  \n  RETURN result;\nEND;\n$$;",
  "returncode": 1,
  "logs": [
    "ERROR 1064 (42000) at line 1: You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 1 column 26 near \"FUNCTION get_optimization_metrics(",
    "  days_back INT DEFAULT 7,",
    "  campaign_filter TEXT DEFAULT '31DWC2026'",
    ")",
    "RETURNS JSON",
    "LANGUAGE plpgsql",
    "AS $$",
    "DECLARE",
    "  result JSON\""
  ]
}